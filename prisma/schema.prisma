// Schéma Prisma pour 3D World — e-commerce impression 3D
// Modèles : utilisateurs, catégories, produits, variantes, commandes, paramètres boutique

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  CLIENT
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum ShippingMethod {
  DELIVERY
  PICKUP
}

model User {
  id         String   @id @default(uuid())
  email      String   @unique
  name       String?
  phone      String?
  role       UserRole @default(CLIENT)
  supabaseId String   @unique @map("supabase_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  orders     Order[]

  @@map("users")
}

model Category {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?
  order       Int       @default(0)
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  products    Product[]

  @@map("categories")
}

model Product {
  id          String           @id @default(uuid())
  name        String
  slug        String           @unique
  description String
  price       Decimal          @db.Decimal(10, 2)
  images      String[]
  hasVariants Boolean          @default(false) @map("has_variants")
  isActive    Boolean          @default(true) @map("is_active")
  categoryId  String           @map("category_id")
  category    Category         @relation(fields: [categoryId], references: [id])
  variants    ProductVariant[]
  orderItems  OrderItem[]
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  @@map("products")
}

model ProductVariant {
  id            String      @id @default(uuid())
  productId     String      @map("product_id")
  product       Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  name          String
  priceOverride Decimal?    @map("price_override") @db.Decimal(10, 2)
  attributes    Json        @default("{}")
  isActive      Boolean     @default(true) @map("is_active")
  createdAt     DateTime    @default(now()) @map("created_at")
  orderItems    OrderItem[]

  @@map("product_variants")
}

model Order {
  id              String         @id @default(uuid())
  userId          String?        @map("user_id")
  user            User?          @relation(fields: [userId], references: [id])
  email           String
  name            String
  phone           String?
  status          OrderStatus    @default(PENDING)
  totalAmount     Decimal        @map("total_amount") @db.Decimal(10, 2)
  shippingMethod  ShippingMethod @map("shipping_method")
  shippingCost    Decimal        @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  shippingAddress String?        @map("shipping_address")
  stripeSessionId String?        @unique @map("stripe_session_id")
  items           OrderItem[]
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  @@map("orders")
}

model OrderItem {
  id        String          @id @default(uuid())
  orderId   String          @map("order_id")
  order     Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String          @map("product_id")
  product   Product         @relation(fields: [productId], references: [id])
  variantId String?         @map("variant_id")
  variant   ProductVariant? @relation(fields: [variantId], references: [id])
  quantity  Int
  unitPrice Decimal         @map("unit_price") @db.Decimal(10, 2)

  @@map("order_items")
}

model ShopSettings {
  id                    String   @id @default("default")
  shopName              String   @default("3D World") @map("shop_name")
  shippingFixedPrice    Decimal  @default(5.00) @map("shipping_fixed_price") @db.Decimal(10, 2)
  freeShippingThreshold Decimal? @map("free_shipping_threshold") @db.Decimal(10, 2)
  pickupEnabled         Boolean  @default(false) @map("pickup_enabled")
  pickupAddress         String?  @map("pickup_address")

  @@map("shop_settings")
}
